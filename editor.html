<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°å›¾ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100%; cursor: grab; }
        #map.adding-mode { cursor: crosshair !important; }
        
        #editor-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 340px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        h3 { margin: 0 0 5px 0; color: #333; font-size: 16px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .section-title { font-size: 12px; font-weight: bold; color: #666; margin-top: 5px; }
        
        .input-group { display: flex; gap: 5px; margin-bottom: 5px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        
        button { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-search { background: #3b82f6; width: 100%; }
        .btn-add { background: #f59e0b; width: 100%; }
        .btn-add.active { background: #d97706; }
        .btn-export { background: #10b981; margin-top: 10px; }
        .btn-export:hover { background: #059669; }

        .status-bar { font-size: 12px; color: #555; background: #f3f4f6; padding: 8px; border-radius: 4px; }
        .highlight { color: #d946ef; font-weight: bold; }
        .new-tag { color: #f59e0b; font-weight: bold; }

        textarea { width: 100%; height: 120px; resize: vertical; font-size: 12px; font-family: monospace; border: 1px solid #ccc; border-radius: 4px; padding: 5px; display: none; }
    </style>
</head>
<body>

<div id="editor-panel">
    <h3>åœ°å›¾ç¼–è¾‘å™¨</h3>
    
    <div class="section-title">æŸ¥æ‰¾ç°æœ‰æ™¯ç‚¹</div>
    <div class="input-group">
        <input type="text" id="search-input" placeholder="è¾“å…¥åå­—æŸ¥æ‰¾..." onkeyup="if(event.key==='Enter') searchSpot()">
        <button class="btn-search" style="width: auto;" onclick="searchSpot()">æŸ¥æ‰¾</button>
    </div>

    <hr style="border:0; border-top:1px dashed #ccc; width:100%;">

    <div class="section-title">æ–°å¢æ™¯ç‚¹</div>
    <div class="input-group">
        <input type="text" id="new-name" placeholder="æ™¯ç‚¹åç§°">
        <input type="text" id="new-area" placeholder="æ‰€å±åŸå¸‚" list="city-list">
        <datalist id="city-list">
            <option value="é•¿æ²™"><option value="æ ªæ´²"><option value="æ¹˜æ½­"><option value="è¡¡é˜³"><option value="é‚µé˜³">
            <option value="å²³é˜³"><option value="å¸¸å¾·"><option value="å¼ å®¶ç•Œ"><option value="ç›Šé˜³"><option value="éƒ´å·">
            <option value="æ€€åŒ–"><option value="æ¹˜è¥¿"><option value="æ°¸å·"><option value="å¨„åº•"><option value="åŒå³°"><option value="æ–°åŒ–">
        </datalist>
    </div>
    <button id="btn-add-mode" class="btn-add" onclick="toggleAddMode()">ç‚¹å‡»æ­¤å¤„å¼€å¯æ–°å¢æ¨¡å¼</button>
    
    <div class="status-bar" id="status">
        ç°æœ‰æ™¯ç‚¹: <span class="highlight" id="count">0</span> ä¸ª<br>
        æœ¬æ¬¡æ–°å¢: <span class="new-tag" id="new-count">0</span> ä¸ª<br>
        <span id="tip" style="color:#888;">æç¤º: æ‹–åŠ¨å›¾æ ‡ä¿®æ­£ä½ç½®</span>
    </div>
    
    <button class="btn-export" onclick="exportData()">ç”Ÿæˆä»£ç </button>
    <textarea id="result-area" placeholder="ä»£ç ç”ŸæˆåŒº"></textarea>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="js/data.js"></script>
<script src="js/geo-data.js"></script> 

<script>
    // åˆå§‹åŒ–åœ°å›¾
    const map = L.map('map').setView([27.7017, 111.9963], 9);
    
    L.tileLayer('https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
        subdomains: ["01", "02", "03", "04"], attribution: 'Â© é«˜å¾·åœ°å›¾'
    }).addTo(map);

    // åŠ è½½è¾…åŠ©è¾¹ç•Œ
    if (typeof hunanGeoData !== 'undefined') {
        L.geoJSON(hunanGeoData, { style: { color: "#3b82f6", fillOpacity: 0.05, weight: 1 } }).addTo(map);
    }

    const markers = {}; 
    let isAdding = false; 
    let newSpotsAdded = []; 

    const cityColors = {
        "é•¿æ²™": "#ef4444", "æ ªæ´²": "#3b82f6", "æ¹˜æ½­": "#dc2626", "è¡¡é˜³": "#8b5cf6",
        "é‚µé˜³": "#06b6d4", "å²³é˜³": "#10b981", "å¸¸å¾·": "#f472b6", "å¼ å®¶ç•Œ": "#0d9488",
        "ç›Šé˜³": "#84cc16", "éƒ´å·": "#6366f1", "æ€€åŒ–": "#f59e0b", "æ¹˜è¥¿": "#a855f7",
        "å¨„åº•": "#d946ef", "æ°¸å·": "#666"
    };
    function getColor(area) {
        for (let k in cityColors) { if (area.includes(k)) return cityColors[k]; }
        return "#333";
    }

    // æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
    function addMarkerToMap(s, isNew = false) {
        const color = isNew ? "#f59e0b" : getColor(s.area);
        const border = isNew ? "3px solid red" : "2px solid white";
        
        const myIcon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background:${color}; width:14px; height:14px; border-radius:50%; border:${border}; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>
                   <div style="position:absolute; top:-20px; left:-50px; width:100px; text-align:center; font-size:12px; font-weight:bold; color:#333; text-shadow:1px 1px 0 #fff;">${s.name}</div>`,
            iconSize: [14, 14],
            iconAnchor: [7, 7]
        });

        const m = L.marker([s.lat, s.lng], { 
            icon: myIcon,
            draggable: true,
            title: s.name 
        }).addTo(map);

        // æ‹–åŠ¨æ›´æ–°åæ ‡
        m.on('dragend', function(e) {
            const newPos = e.target.getLatLng();
            s.lat = parseFloat(newPos.lat.toFixed(4));
            s.lng = parseFloat(newPos.lng.toFixed(4));
            
            e.target.bindTooltip(`å·²æ›´æ–°: ${s.lat}, ${s.lng}`, {permanent:true, direction:'top'}).openTooltip();
            setTimeout(() => e.target.closeTooltip(), 1500);
        });

        m.bindPopup(`<b>${s.name}</b><br>${s.area}`);
        markers[s.name] = m;
    }

    // åˆå§‹åŒ–ç°æœ‰æ ‡è®°
    if (typeof spots !== 'undefined') {
        document.getElementById('count').innerText = spots.length;
        spots.forEach(s => addMarkerToMap(s));
    }

    // æœç´¢åŠŸèƒ½
    function searchSpot() {
        const keyword = document.getElementById('search-input').value.trim();
        if (!keyword) return;
        for (let name in markers) {
            if (name.includes(keyword)) {
                const m = markers[name];
                map.flyTo(m.getLatLng(), 15);
                m.openPopup();
                return;
            }
        }
        alert("æœªæ‰¾åˆ°è¯¥æ™¯ç‚¹");
    }

    // åˆ‡æ¢æ–°å¢æ¨¡å¼
    function toggleAddMode() {
        const name = document.getElementById('new-name').value.trim();
        const area = document.getElementById('new-area').value.trim();
        
        if (!name || !area) {
            alert("è¯·å…ˆè¾“å…¥æ™¯ç‚¹åç§°å’Œæ‰€å±åŸå¸‚");
            return;
        }

        isAdding = !isAdding;
        const btn = document.getElementById('btn-add-mode');
        const mapDiv = document.getElementById('map');
        const tip = document.getElementById('tip');

        if (isAdding) {
            btn.classList.add('active');
            btn.innerText = "å–æ¶ˆæ–°å¢ (æˆ–ç‚¹å‡»åœ°å›¾æ·»åŠ )";
            mapDiv.classList.add('adding-mode');
            tip.innerHTML = "<span style='color:red; font-weight:bold;'>è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä½ç½®</span>";
        } else {
            btn.classList.remove('active');
            btn.innerText = "ç‚¹å‡»æ­¤å¤„å¼€å¯æ–°å¢æ¨¡å¼";
            mapDiv.classList.remove('adding-mode');
            tip.innerText = "æç¤º: æ‹–åŠ¨å›¾æ ‡ä¿®æ­£ä½ç½®";
        }
    }

    // åœ°å›¾ç‚¹å‡»äº‹ä»¶
    map.on('click', function(e) {
        if (!isAdding) return;

        const name = document.getElementById('new-name').value.trim();
        const area = document.getElementById('new-area').value.trim();

        const newSpot = {
            "name": name,
            "lat": parseFloat(e.latlng.lat.toFixed(4)),
            "lng": parseFloat(e.latlng.lng.toFixed(4)),
            "area": area,
            "icon": "ğŸ“",
            "tags": "æ–°å¢",
            "image": "", 
            "desc": `ä½äº${area}çš„${name}`
        };

        addMarkerToMap(newSpot, true);
        spots.push(newSpot);
        newSpotsAdded.push(newSpot);
        
        document.getElementById('new-count').innerText = newSpotsAdded.length;
        document.getElementById('count').innerText = spots.length;
        
        isAdding = false;
        toggleAddMode(); 
        document.getElementById('new-name').value = '';
    });

    // å¯¼å‡ºä»£ç 
    function exportData() {
        const area = document.getElementById('result-area');
        area.style.display = 'block';
        
        let jsonStr = JSON.stringify(spots, null, 4);
        let finalOutput = `// æ™¯ç‚¹æ•°æ®é…ç½®\nconst spots = ${jsonStr};`;
        
        area.value = finalOutput;
        area.select();
        
        if(navigator.clipboard) {
            navigator.clipboard.writeText(finalOutput).then(() => {
                alert("ä»£ç å·²å¤åˆ¶ï¼Œè¯·è¦†ç›– js/data.js");
            }).catch(() => {
                alert("è¯·å…¨é€‰å¤åˆ¶ä¸‹æ–¹å†…å®¹ï¼Œè¦†ç›– js/data.js");
            });
        } else {
            alert("è¯·å…¨é€‰å¤åˆ¶ä¸‹æ–¹å†…å®¹ï¼Œè¦†ç›– js/data.js");
        }
    }
</script>

</body>
</html>